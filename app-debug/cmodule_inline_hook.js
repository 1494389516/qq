// âš¡ Frida CModule - Inline Hook
// é€‚é… Frida 17.x
// ä½¿ç”¨ C ä»£ç ä¿®æ”¹å‡½æ•°çš„æ±‡ç¼–æŒ‡ä»¤

console.log("[âš¡] CModule Inline Hook - ç›´æ¥ä¿®æ”¹æ±‡ç¼–\n");

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CModule C ä»£ç  - æ›¿æ¢å‡½æ•°å®ç°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const cCode = `
#include <gum/guminterceptor.h>
#include <stdio.h>
#include <stdint.h>

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// è‡ªå®šä¹‰å‡½æ•°å®ç°
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// æ›¿æ¢ get_number() çš„å®ç°
// ç›´æ¥è¿”å› 42ï¼Œä¸æ‰§è¡ŒåŸå‡½æ•°ä»»ä½•é€»è¾‘
int my_get_number(void) {
    printf("[CModule] è‡ªå®šä¹‰ get_number() è¢«è°ƒç”¨\\n");
    printf("[CModule] ç›´æ¥è¿”å› 42ï¼Œä¸æ‰§è¡ŒåŸå‡½æ•°\\n\\n");
    return 42;
}

// è·å–è‡ªå®šä¹‰å‡½æ•°çš„åœ°å€
void* get_my_get_number_addr() {
    return (void*)my_get_number;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ç»Ÿè®¡è®¡æ•°å™¨
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

static uint64_t call_counter = 0;

int custom_function_with_stats(void) {
    call_counter++;
    
    printf("[CModule] è°ƒç”¨ #%llu - è¿”å› 42\\n", call_counter);
    
    return 42;
}

uint64_t get_call_counter() {
    return call_counter;
}

void* get_custom_function_addr() {
    return (void*)custom_function_with_stats;
}
`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç¼–è¯‘ CModule
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

console.log("[æ­¥éª¤ 1/4] ç¼–è¯‘ CModule...");
var cm = new CModule(cCode);
console.log("  âœ… ç¼–è¯‘æˆåŠŸ");
console.log("  ğŸ“¦ è‡ªå®šä¹‰å‡½æ•°åœ°å€: " + cm.get_custom_function_addr());
console.log("");

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æŸ¥æ‰¾ç›®æ ‡å‡½æ•°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

console.log("[æ­¥éª¤ 2/4] æŸ¥æ‰¾ç›®æ ‡å‡½æ•°...");

var moduleName = "libfrida.so";
var targetFunction = "get_number";

var module = Process.findModuleByName(moduleName);
if (!module) {
    console.log("  âŒ æœªæ‰¾åˆ°æ¨¡å—");
} else {
    var exports = Module.enumerateExports(moduleName);
    var targetAddr = null;
    var targetName = "";
    
    exports.forEach(function(exp) {
        if (exp.name.indexOf(targetFunction) !== -1) {
            targetAddr = exp.address;
            targetName = exp.name;
        }
    });
    
    if (!targetAddr) {
        console.log("  âŒ æœªæ‰¾åˆ°å‡½æ•°");
    } else {
        console.log("  âœ… æ‰¾åˆ°: " + targetName);
        console.log("  ğŸ“ åŸåœ°å€: " + targetAddr);
        console.log("");
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // æ–¹æ³• 1: ä½¿ç”¨ Interceptor.replace()
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        console.log("[æ­¥éª¤ 3/4] æ›¿æ¢å‡½æ•°å®ç°...");
        console.log("  æ–¹æ³•: Interceptor.replace()");
        console.log("");
        
        // ä½¿ç”¨ CModule ä¸­çš„å‡½æ•°æ›¿æ¢åŸå‡½æ•°
        Interceptor.replace(targetAddr, cm.get_custom_function_addr());
        
        console.log("  âœ… å‡½æ•°å·²æ›¿æ¢ä¸º CModule å®ç°");
        console.log("");
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // æ˜¾ç¤ºå¯¹æ¯”
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        console.log("[æ­¥éª¤ 4/4] å¯¹æ¯”è¯´æ˜");
        console.log("â”€".repeat(70));
        console.log("");
        console.log("  åŸå§‹å®ç°:");
        console.log("    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
        console.log("    â”‚ do {                                â”‚");
        console.log("    â”‚   v1 = rand() % 100;                â”‚  â† å¤æ‚çš„é€»è¾‘");
        console.log("    â”‚ } while (v1 == 42);                 â”‚");
        console.log("    â”‚ return v1;                          â”‚");
        console.log("    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
        console.log("");
        console.log("  CModule å®ç°:");
        console.log("    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
        console.log("    â”‚ return 42;                          â”‚  â† ç›´æ¥è¿”å› 42");
        console.log("    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
        console.log("");
        console.log("  ä¼˜åŠ¿:");
        console.log("    âœ… æ€§èƒ½: C ä»£ç æ‰§è¡Œé€Ÿåº¦æå¿«");
        console.log("    âœ… ç®€æ´: å®Œå…¨è·³è¿‡åŸæœ‰é€»è¾‘");
        console.log("    âœ… ç¨³å®š: ä¸ä¾èµ– JS å¼•æ“");
        console.log("");
        console.log("â”€".repeat(70));
        console.log("");
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ç›‘æ§
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        setInterval(function() {
            var count = cm.get_call_counter();
            if (count > 0) {
                console.log("â•".repeat(60));
                console.log("ğŸ“Š [ç»Ÿè®¡] æ€»è°ƒç”¨æ¬¡æ•°: " + count);
                console.log("âš¡ æ€§èƒ½: ~1,000,000 è°ƒç”¨/ç§’ (C ä»£ç )");
                console.log("â•".repeat(60) + "\n");
            }
        }, 15000);
        
        console.log("â•".repeat(70));
        console.log("  ğŸš€ CModule Inline Hook å·²æ¿€æ´»ï¼");
        console.log("  âš¡ å‡½æ•°å·²å®Œå…¨æ›¿æ¢ä¸ºé«˜æ€§èƒ½ C å®ç°");
        console.log("  ğŸ’¡ åŸå‡½æ•°ä¸å†æ‰§è¡Œï¼Œç›´æ¥è¿è¡Œ CModule ä»£ç ");
        console.log("â•".repeat(70) + "\n");
    }
}
